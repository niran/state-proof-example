pragma solidity ^0.8.19;

import "forge-std/Test.sol";

import {PulledSlot4788} from "../src/PulledSlot4788.sol";


contract PulledSlot4788Test is Test {
    PulledSlot4788 pulledSlot;

    function setUp() public {
        pulledSlot = new PulledSlot4788(
            // Pull the value of slot 0 of the L1 contract at
            // https://sepolia.etherscan.io/address/0x45b924Ee3EE404E4a9E2a3AFD0AD357eFf79fC49
            0x45b924Ee3EE404E4a9E2a3AFD0AD357eFf79fC49,
            keccak256(abi.encode(0))
        );
    }

    function test_setSlotValue() public {
        // This test must be run against a Sepolia RPC.
        // e.g. `FORK_URL=https://rpc.sepolia.org forge test`
        vm.makePersistent(address(pulledSlot));
        string memory forkUrl = vm.envOr("FORK_URL", string(""));
        vm.skip(_isEmptyString(forkUrl));

        // Timestamp corresponds to beacon root 0xa5e000d8b2268e984d012828a5270467ba89357f8a8f8e0cea5646cb7cd6b4a2
        uint64 beaconTimestamp = 1713367392 + 24;
        // Fork from a block when that timestamp is still in the EIP 4788 beacon root buffer.
        vm.createSelectFork(forkUrl, 5719697);
        _checkChainId(11155111); // Sepolia
        
        // TODO: Store the test data in a JSON file. Foundry has utilities for this.
        bytes32 stateRoot = 0xd2ef0ac8a60fa9d76b4707d74871f1f8554d34b9bdebf1a015402d29aeeada7e;
        bytes32[] memory stateRootProof = new bytes32[](13);
        stateRootProof[0] = 0x93c9df261b889526cb778f516ff5d81ed22cff702c37ec94e65a1a916c6ad836;
        stateRootProof[1] = 0xa3a3a3361e6dae233e98b4847a0acd3b5d06323126a2288276c05fcf0e6d5850;
        stateRootProof[2] = 0x16b5b74ba14e4d190b4430f399647704d1bd8547f9aedb18b355f6cb3a4055cc;
        stateRootProof[3] = 0xc2f0b889126fb00812b9429700480b57e8589a1a9e8ec82bd19680a9167f7a72;
        stateRootProof[4] = 0x886d7aabcac1911c4aaa5458398f44e9f682a38c4c2a62d77febcceaf6d7327c;
        stateRootProof[5] = 0xb1d9990200000000000000000000000000000000000000000000000000000000;
        stateRootProof[6] = 0x9b9ca65986fedb2c94dcd34098cd387d6f10da10881bb9b8cf3cd7f980414b5e;
        stateRootProof[7] = 0xdb56114e00fdd4c1f85c892bf35ac9a89289aaecb1ebd0a96cde606a748b5d71;
        stateRootProof[8] = 0xe532c1a53a03139ae9be3c21bc910c4b61349ae6ecd904a6a5b67db12b25c27e;
        stateRootProof[9] = 0x85af0947b459b369fde4a1650db731804a389a4778bbeedc0e3e1251627e87e3;
        stateRootProof[10] = 0xd2e269601aef3050553e3a1401b6042587c1f7da7d99dc975e62c2f879cf137e;
        stateRootProof[11] = 0x3e7821d6eda954dc0aa13fc9b0d2326faa5cd12ccc7baeffefae4eeb6ead2fcf;
        stateRootProof[12] = 0x87ef5b44b94155b8494a0e3aba6502ac7c68394762c783a6abfa627d7fca2663;

        bytes[] memory accountProof = new bytes[](8);
        accountProof[0] = bytes(hex"f90211a0e37380fcf4ff924253952e93b03ad0a353d4acea62a88e47deb1a73bdd2ae09ca00f29123d28a4e57a97f01eaff0a14ceb4c4d07791e85ff0808e5adf40aebfc9ba01eccb7b70ad3b9edadc92b2ace527c2ffd51dc35ae5d32bf66999c1535e680d4a006dab8430e8e2237db14db11d079d51346eb1cae5210d8ff25675736436a73d6a0bcb8a3641d637be2a7840445710442abf627d35b04eb1d5c70ee11f195b76c94a0ab0b17d88e82b0b5fef3166a1669f3bcab1d617dabadd1a5cb04e29062deb127a07d7e5f5b23765507ea610a3b3edb5a72f8d7121b8ee21b84bb0151a86bfd8514a072b696c094bb68bccb39a6cb74d7170640dd68de0c732c9c04e44a6426a303d5a0664eaf87336fa9623934ff3316d5ded89a9c99acfe806e92cb2696ea22b74322a03586d87d23c7cc6beb8850cd8cb07b4661eed37a2ad6a27f5d1f365e3ec7d53aa09eecc50b6ef2faf1b0688051aa8c9f1026c36d039e479300514052da365ed9cea0c3a4be86fd60613fca0aea2d8a103e8c7e06256a3ccb30c9789e93cc3b8c708ba02ac74a2bb31cb1221fa1492fa4974002b7c3707237d7be8f03a186f487d31e2ba04834703372e080c9b266fb31d072cfebbe3187c91e89b2d4432ad2e1e3ed21b7a06aa266b2442077e184a0092b600314bb7687a7eb4b54df38c99eb39ced37b28ca0c62fc959696ede876c1a8d481037e0768a49e90d99093d531afd6c0e48912df580");
        accountProof[1] = bytes(hex"f90211a03b5b11882adf0dc83019dd6a48dc231f3279ffaafeeef6da7dfb0bf606274788a0223900647238bffd5a64da532328307d2bb9e4ab54206282c12281b5ec90d550a04fb4c41895d1649ba421f611f615f4fd27985076ea3ffd746d5772557ac557faa04d7376e01200f96f2bf7c672ad792fc17cd5a59202829083a5aa2d069109ac2ba020c1f0d74cae13799f2c6ae7160d5471f10faa5d350027acb55fdfb29cf2942ca0963fcff2874e17c59a3be2df850b9975c1c15023bcdb9b0634cb9f89c6843734a0122aa6da585bf0cb9e83a47c1350e48dc1e21ccd50bcb8940e930f73b2a5ae51a087f9b0592fd1ac47c8451db783fe828a868c1ff0e277f84c5e625919127380fda0e2610bc6fdd721aa109f4819d34af8872ba4273ee01edb4a27c7cabd0464ac09a04cc9b07f8a0fc2de80a51942aefd8f1e82d22e39ffc1fd6f055c211096997c93a0e87927907bb030587f7da258c8c593effe174838926143c7fc29571830ddfadda0145e7cad16364f6d3a4b9d513c81c124f29a822d52f880f5784d2b381a728e0da0737869684262db4d2a2022efad040dd65f46f4d3f04e008a00d4a530485bb487a0adada4800f41fc29eaac77f50e6b3ff57115ba74fb48c3b17a76f0647f7ee699a09f48b3c1671e4bf35afcebabc3e6b8297777ea78c4ff8cd7243c44c3adbeba94a06ad3482915681b0279162a68b076da0a9eb7539fbaf58ebe02b8b70f87ecd97080");
        accountProof[2] = bytes(hex"f90211a0618782f688abd4b259d2fb6bb7218301b5eeb494ab65a7be5ad850bf95d8ae34a045bddc3a6ed7d6fa9341486b332cd47d7f39e8f069a17030150d22a0728aa984a0f63bad9f478f700952cdce0d648ae827a3e0690d15fff8366e07ae402c932b03a0f0c7df851bd7b6d2a26d7b68972ded4d137ac79464374d513895a531ca8f8b8ca02a8ad396295a08c4962b679ae5cc0b6b3290760ddf715173c41511c2b871b679a0e432e9c4a68f843168a060959a6b9f3ba5fb924e60a0abfaeeed3d287b3d62b9a0030b4feb5068b04450f644b647e17403a740bacfbf44a6e36fd7d62f07c2e43aa01a8cdfe5816c9c6aa8ff4cdb61006f4eb87a1c4e3699b15c5e549147bd0f58f7a0eb7d526066ee166a116a3710cf2ba068d1dca9018552c63df08e7b651e72d856a0ab74a460d745f1da43e23df6c1381b27803d81471c70ebff070bb8097a6852c9a0446c4d390174892852f53703c3b216144c9d5b382af7f3d67f9d115df6e3c9b6a0e375a6de0ee1b7eacfca2feb22565291864a8b475d91e2d1313a9b96a0a6fe40a03f5ac505b4f515f6219dd787d317f15736eea988505a4e4328dbcfb8a46fc6fea00d65ef837709694fccf176547ebd7b52474bcd8cb5e4b8cdd41c4fdbe5fd64a4a087df76c4c9572a7b3be7802942f3ee7f443c8f69d8122d2a6d45dfacd87a9adfa0a8732d329bb1893c001db4d5817db2ae928e9d793103874a8f6adff3999d196680");
        accountProof[3] = bytes(hex"f90211a06f3041cd4b05b8510d450064d8acc432e73f7878c501f07cdaa76a5725418767a0ff4364d2fddac3e10c8897c3fa9e1e94ce46163469e32a3c37fe34a4ffdcc3b0a0381f9e5f17c695edf52317308020623ae5b30c6796912ff792291be6a6c07f33a0d8bc436f7b947a519aaf31a8412d78f121ef51e1ea957ac602fbdfb6864bf7c0a0a80a2ed80b19d1fad1086810e19500bea55da6d275818c2ac8010afdb2d7cdfca054264c54ce89180bc5498f4c528b9a25824eb19d5ce56d34abb2254956fc3b9ba07ba0ac4fee0f658ce12cb7dec49f97817fef487672352c47980dc437b908f945a0ebd5950063b7926e0f9d666245827143e654bb06aff1cd21d67f59893b39cd80a0621748bd81122a86a280ea309731ae21bc8e286832db59fad120646a0aa598b0a0deb25a38f15b7ee2174a1c3d838681c2153c9c516ec3d470b25fbd23b3c252c1a0a1ebfdbdbf0755feae5fc2a66d977b9bfb56f0c18255bd322ee85928a13efbb4a0c51c0f3bedaa97c9ed275a1712a74fc701d64e21b4c2d606aaad01e74b50de87a0dda14059830a3459c8280472eff53dcf9c92acc2b1dadfade6da3510e64f16b5a0eaa79557cbf37763e2a9bc28650056fcc1de988e54be2695dc42573333b773c5a0a25068cd0bc28544c1371f22caf02537d43454cf52a4556d363d7f3e98882495a033cada54f856b5e9b5c69ebf7b29e8b135017b96b192d0dee04411498efa171a80");
        accountProof[4] = bytes(hex"f90211a0d090880e499f096366612afb64c7d43c3503583331ff0c0c7154b87bd6e853ada09965a856bb6cbd844d12306983e8e432c3889f58b6e650c929bec7cc1824438ba0357601611ccbb2da4ae41e73e002871b6fa7ee19b4658950dbac37c1269b67d0a05c504c23691353d5beca9acf2996fae7b684a664f434c4c8506d2e288a739a64a04adf238db0e7f901154716e0b38816fa471e6b6377b105276125f5f18f544d4fa0b1e0f7289de8ba3915df17e3a404135a7d5f80103d28895cafe870ca46881487a0d8d71796d04a55850d5fe6a96911ffc29423ab0f0c85245b516cd7b684d3259ba0477a3b087e3a25a9237000a52457918ade1100b663b4555a19de30e0a06c2472a0fafbcbfd11d2c236c8f513c7e745a952475c038faba1a7e45f91c3b3602229e2a008aac38966a68f8700804ba0808e3e2457e109f9a41f61c6b12b70cffe2a3392a0eb024989dccac8d390e43f23fd36a72a5ecf6f341450d5c7f5f3897a4f476ce5a03168a34c626206a73f1ebe42b54080cf77d2bb742b5e9804f36e480565f4ac22a04345075bcd9eff3c2ddf8e7415e35ea8e848301d85dac80388fbff0db8d22db2a05687629619bc017393809756e6766ff7c27ea0cf8e631a086827e792b8ea2e00a0e9ee20e53d717c403bf16cba78ccfb1a25a72c474854547f213f0e47d1050a3ba0d3583f977793c56a5b045453d453bab2499da9b2278030b402ee68cf47814ae880");
        accountProof[5] = bytes(hex"f901d1a032cc7aee1e4fff0e19a8c821cd13953900f587091b7ef4168d8899e7b2a81830a0bea9d3ad4a89e25386990bd310f425a3aa58a10716cf46ef026c9c08c08f9502a016b509690c804c078b4d70646c02f9a288e9520f439ac300a8322a50216848eea0f699cf57a9709e98eafc7700411421dd95272cea6c45f2ab543a1f0b03717ea2a0887f4dec52cdbbc65ae5e310418e7f6c904359896afa9d4c2e41cd668dd4ff55a02b09047dc9db11a443549054cfc94c9a559ac2638b4541d030ee7a6b3d78ada7a0cb0e061333762bcaba537a876a84a9c7310b8b77fa7494edaf0d67824729a9bba0d3657376d8def88f64210ef977b8d66e85d9ce6d518ae9268b51e305386ed29ca065f357a275b448230b07c8d0a0a0d21bb3a9a95d1498ae7a7030acf68f9588d8a057f7a83ba044111100d30462d391201f2a181100899c96c16e958bec33143b7480a0241c16b35a1379d34165ca696f61121066fa942521b3eac17fc2b09c960337c6a059a6d40faa1b527b8230ece6674549fe5ca4a713726ff687dc6de11459eff2b780a0aab58fd3d94cf5aa7c8e003ea7b7f72d9a9556b51a7aee160d4d70c776c2731ea0f668da4ae58d11dc25296d2a35dda89852a0178203af5989fc4fb4263efa8d2280");
        accountProof[6] = bytes(hex"f87180a0708c7f62413dcfe9f17b7878d9087833c89f8a75e3d1585dcb9a2f421559cf2b808080808080808080a0fc3a8cc74f051874a8e7716b51656d577c97b1115712f6a25cfc57b14d42dad3a08614be3110e9da292f6cadf1e6c48c533cad91c07b9b6daa70cfc0ee4714219d80808080");
        accountProof[7] = bytes(hex"f8669d3f5dbf40c0f1562fe39f2b9e02d9a83f3ffd128399fcc792d09218273cb846f8440180a0089cf54f2ebabe8a15aebb758d99b25970a16884a7e4e59a889e24dcbc327877a0765bb438c87fec6db0c6028b5cd9bfc0fa8d8332299e8f571768f3f32a5ae40c");

        bytes[] memory slotProof = new bytes[](2);
        slotProof[0] = bytes(hex"f8d18080a0f8406fa2b3ad233dd92b5b4f3b344c37525a99875ee3588f7d68f449a7e0f069a0f6555720d931acc177d2164a8dc1465cbf7c7146944f6d2bf86c70b3aeb499e5808080a0211d6783eb2d7ddd6713a21a3ad9c8672dcc6fbee2694425487349855c0a4c3b8080a05105c5a2a4658149fe0271f2e3b2985fe2dc718cad6db871bbf23d78af85ff58a0a094ac537e31b5ed13ab17c40edb286e362ecc763e44ca0bc59630e33d6cec09808080a048ca42babda7e898e61974776cd4b1057e8887833dc286a04cebe51d8710c87780");
        slotProof[1] = bytes(hex"f843a0390decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e563a1a0134369744e19ab0c98e12016c98a29fe64a9bd352b226406da61a784522dc490");
        
        pulledSlot.setSlotValue(stateRoot, stateRootProof, accountProof, slotProof, beaconTimestamp);
        assertEq(bytes32(pulledSlot.slotValue()), 0x134369744e19ab0c98e12016c98a29fe64a9bd352b226406da61a784522dc490);
    }

    function _checkChainId(uint256 chainId) internal view {
        if (chainId != block.chainid) {
            revert("wrong chain id");
        }
    }

    function _isEmptyString(string memory str) internal pure returns (bool) {
        return bytes(str).length == 0;
    }
}
